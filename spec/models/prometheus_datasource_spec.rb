include Grafana

require 'json'

describe PrometheusDatasource do
  subject { PrometheusDatasource.new({}) }

  it 'raises an error if an improper response format is given' do
    expect { subject.send(:preformat_response, "wrong format") }.to raise_error(UnsupportedQueryResponseReceivedError)
  end

  it 'does handle the query results from bug #31' do
    expect { subject.send(:preformat_response, {"results":{"A":{"frames":[{"schema":{"name":"up{app=\"\", criticality=\"low\", env=\"production\", hostname=\"\", instance=\"9100\", job=\"node\", org=\"Root entity\"}","refId":"A","meta":{"custom":{"resultType":"matrix"}},"fields":[{"name":"Time","type":"time","typeInfo":{"frame":"time.Time"}},{"name":"Value","type":"number","typeInfo":{"frame":"float64","nullable":true},"labels":{"__name__":"up","app":"","criticality":"low","env":"production","hostname":"","instance":"9100","job":"node","org":"Root entity"},"config":{"displayNameFromDS":"your_name"}}]},"data":{"values":[[1660730100000,1660730400000,1660730700000,1660731000000,1660731300000,1660731600000,1660731900000,1660732200000,1660732500000,1660732800000,1660733100000,1660733400000,1660733700000,1660734000000,1660734300000,1660734600000,1660734900000,1660735200000,1660735500000,1660735800000,1660736100000,1660736400000,1660736700000,1660737000000,1660737300000,1660737600000,1660737900000,1660738200000,1660738500000,1660738800000,1660739100000,1660739400000,1660739700000,1660740000000,1660740300000,1660740600000,1660740900000,1660741200000,1660741500000,1660741800000,1660742100000,1660742400000,1660742700000,1660743000000,1660743300000,1660743600000,1660743900000,1660744200000,1660744500000,1660744800000,1660745100000,1660745400000,1660745700000,1660746000000,1660746300000,1660746600000,1660746900000,1660747200000,1660747500000,1660747800000,1660748100000,1660748400000,1660748700000,1660749000000,1660749300000,1660749600000,1660749900000,1660750200000,1660750500000,1660750800000,1660751100000,1660751400000,1660751700000],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]}}]}}}.to_json) }.not_to raise_error()
  end
end
